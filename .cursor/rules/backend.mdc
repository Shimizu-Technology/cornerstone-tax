---
description: Backend development rules for Rails API
globs: ["backend/**/*"]
alwaysApply: false
---

# Rails Backend Rules

## General
- Rails 7+ in API mode (no views, no asset pipeline)
- Ruby 3.2+
- PostgreSQL database (Neon)

## Naming Conventions
- Models: singular, CamelCase (`TaxReturn`, `WorkflowEvent`)
- Tables: plural, snake_case (`tax_returns`, `workflow_events`)
- Controllers: plural (`TaxReturnsController`)
- Foreign keys: `{table_singular}_id` (`client_id`, `user_id`)

## API Structure
- Namespace under `Api::V1`
- RESTful routes
- JSON responses with snake_case keys
- Use serializers for response formatting (e.g., Alba, Blueprinter, or jbuilder)

## Controllers
- Keep controllers thin
- Complex logic goes in service objects (`app/services/`)
- Use strong parameters
- Handle errors gracefully with proper HTTP status codes

## Models
- Validations in models
- Use scopes for common queries
- Callbacks only for simple side effects (prefer service objects for complex logic)

## Services
- Put business logic in `app/services/`
- Name pattern: `{Action}{Resource}Service` (e.g., `CreateClientService`)
- Single responsibility per service

## Background Jobs
- Use Sidekiq (or Solid Queue for simplicity)
- Jobs for: email sending, SMS sending, heavy processing
- Keep jobs idempotent

## Database
- Always add indexes for foreign keys and commonly queried columns
- Use database-level constraints where appropriate
- Encrypt sensitive data (bank account numbers, SSN if stored)

## Encryption (Active Record Encryption)
Bank account data is encrypted at rest:
```ruby
# In Client model
encrypts :bank_routing_number
encrypts :bank_account_number
```

Required environment variables:
```
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=...
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=...
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=...
```

Generate keys: `bin/rails db:encryption:init`

## Email (Resend)
- Used for user invitation emails
- Configure `RESEND_API_KEY` and `MAILER_FROM_EMAIL`
- **Note**: Resend requires domain verification for production; testing emails only work to the account owner's email

## Authentication (Clerk JWT)
- Clerk handles auth; backend verifies JWT tokens
- JWT verification via `ClerkAuth` service using JWKS endpoint
- Include `ClerkAuthenticatable` concern in controllers
- **Invite-only**: Admins create user records first; only those emails can sign up
- First user automatically gets `admin` role

### Authentication Methods (from ClerkAuthenticatable)
```ruby
before_action :authenticate_user!  # Requires valid token & user in DB
before_action :require_staff!      # Must be admin or employee
before_action :require_admin!      # Must be admin
```

### Environment Variables
```
CLERK_JWKS_URL=https://your-app.clerk.accounts.dev/.well-known/jwks.json
```

## Audit Logging
Two separate audit systems:

### 1. workflow_events (Tax Return Specific)
- Linked to `tax_return_id`
- Auto-logged via model callbacks on TaxReturn
- Types: `status_changed`, `assigned`, `note_added`, `income_source_added/updated/removed`

### 2. audit_logs (General Purpose)
- Polymorphic (`auditable_type`, `auditable_id`)
- Manually logged in controllers
- Used for: client edits, time entries, user management
- Use `AuditLog.log(auditable:, action:, user:, changes_made:, metadata:)`

## File Structure
```
backend/
├── app/
│   ├── controllers/
│   │   └── api/v1/          # All API controllers
│   ├── models/              # ActiveRecord models
│   ├── services/            # Business logic
│   ├── jobs/                # Background jobs
│   └── serializers/         # Response formatting
├── config/
├── db/
│   └── migrate/             # Migrations
└── spec/ or test/           # Tests
```

## Shared Database with FastAPI
- Rails OWNS the schema (all migrations through Rails)
- FastAPI reads the same database but doesn't manage migrations
- Both can read/write to all tables
- Coordinate column/table changes through Rails first
